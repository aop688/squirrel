#!/bin/bash

set -e

project_file=Squirrel.xcodeproj/project.pbxproj
test -f "${project_file}"

anchor=(81 82 rime_ice.schema.yaml)
anchor_lib=(9D 9A librime-lua.dylib)

# 从 project.pbxproj 中找到最大的 ID，避免重复
lastid=$(grep -oE '441E63[0-9A-F]{2}22B7' "${project_file}" | sed 's/441E63//;s/22B7//' | sort -u | tail -1)
lastid=${lastid:-80}  # 如果没有找到，默认从 80 开始

obj_entry() {
    local id=$1
    local ref=$2
    local file="$3"
    echo "441E63${id}22B7E96F006DCCDD /* ${file} in Copy Shared Support Files */ = {isa = PBXBuildFile; fileRef = 441E63${ref}22B7E90C006DCCDD /* ${file} */; };"
}

copy_files_entry() {
    local id=$1
    local ref=$2
    local file="$3"
    echo "441E63${id}22B7E96F006DCCDD /* ${file} in Copy Shared Support Files */,"
}

file_ref_entry() {
    local id=$1
    local ref=$2
    local file="$3"
    local basename=$(basename "$file")
    echo "441E63${ref}22B7E90C006DCCDD /* ${basename} */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text; name = ${basename}; path = data/plum/${file}; sourceTree = \"<group>\"; };"
}

group_entry() {
    local id=$1
    local ref=$2
    local file="$3"
    local basename=$(basename "$file")
    echo "441E63${ref}22B7E90C006DCCDD /* ${basename} */,"
}

lib_entry() {
    local id=$1
    local ref=$2
    local lib="$3"
    echo "2C6B9F${id}2BCD086700E327DF /* ${lib} in Copy Rime plugins */ = {isa = PBXBuildFile; fileRef = 2C6B9F${ref}2BCD086700E327DF /* ${lib} */; settings = {ATTRIBUTES = (CodeSignOnCopy, ); }; };"
}

lib_ref_entry() {
    local id=$1
    local ref=$2
    local lib="$3"
    echo "2C6B9F${ref}2BCD086700E327DF /* ${lib} */ = {isa = PBXFileReference; lastKnownFileType = \"compiled.mach-o.dylib\"; name = \"${lib}\"; path = \"lib/rime-plugins/${lib}\"; sourceTree = \"<group>\"; };"
}

frameworks_phase_entry() {
    local id=$1
    local ref=$2
    local lib="$3"
    echo "2C6B9F${id}2BCD086700E327DF /* ${lib} in Copy Rime plugins */,"
}

add_line() {
    local search="^[[:space:]]*$(sed 's/\//\\\//g; s/\*/\\*/g' <<< "${1}")\$"
    sed -i '' "/${search}/a\\
${2}
" "${project_file}"
}

add_file() {
    local file="$1"
    local new_id=$(( ++lastid ))
    local new_refid=$(( ++lastid ))
    local anchor_line
    local new_line

    anchor_line="$(obj_entry ${anchor[@]})"
    new_line="$(obj_entry ${new_id} ${new_refid} "${file}")"
    add_line "${anchor_line}" "${new_line}"

    anchor_line="$(copy_files_entry ${anchor[@]})"
    new_line="$(copy_files_entry ${new_id} ${new_refid} "${file}")"
    add_line "${anchor_line}" "${new_line}"

    anchor_line="$(file_ref_entry ${anchor[@]})"
    new_line="$(file_ref_entry ${new_id} ${new_refid} "${file}")"
    add_line "${anchor_line}" "${new_line}"

    anchor_line="$(group_entry ${anchor[@]})"
    new_line="$(group_entry ${new_id} ${new_refid} "${file}")"
    add_line "${anchor_line}" "${new_line}"
}

add_lib() {
    local lib="$1"
    local new_lib_id=$(( ++lastid ))
    local new_lib_refid=$(( ++lastid ))
    local anchor_line
    local new_line

    # Assuming you have similar 'anchor' values for library entries
    anchor_lib_line="$(lib_entry ${anchor_lib[@]})"
    new_lib_line="$(lib_entry ${new_lib_id} ${new_lib_refid} "${lib}")"
    add_line "${anchor_lib_line}" "${new_lib_line}"

    anchor_lib_line="$(lib_ref_entry ${anchor_lib[@]})"
    new_lib_line="$(lib_ref_entry ${new_lib_id} ${new_lib_refid} "${lib}")"
    add_line "${anchor_lib_line}" "${new_lib_line}"

    anchor_lib_line="$(frameworks_phase_entry ${anchor_lib[@]})"
    new_lib_line="$(frameworks_phase_entry ${new_lib_id} ${new_lib_refid} "${lib}")"
    add_line "${anchor_lib_line}" "${new_lib_line}"
}


data_files=(
    $(find data/plum -type f | sed 's|data/plum/||')
)

lib_files=(
    $(ls lib/rime-plugins/* | xargs basename)
)

for file in "${data_files[@]}"
do
    # 跳过不存在的文件
    if [[ ! -f "data/plum/${file}" ]]; then
        echo "skipping non-existent file: ${file}"
        continue
    fi
    # 检查文件是否已添加（通过检查 fileRef 条目的 path 属性）
    if grep -Fq "path = data/plum/${file};" "${project_file}"
    then
	echo "found ${file}"
	continue
    fi
    echo "adding ${file} to ${project_file}"
    add_file "${file}"
done

for lib in "${lib_files[@]}"
do
    if grep -Fq " ${lib} " "${project_file}"
    then
        echo "found ${lib}"
        continue
    fi
    echo "adding ${lib} to ${project_file}"
    add_lib "${lib}"
done
